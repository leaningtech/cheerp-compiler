#!/usr/bin/make -f

deb_version := $(shell dpkg-parsechangelog | sed -n 's/^Version: //p')

%:
	dh $@ --parallel --builddirectory=build

override_dh_auto_configure:
	mkdir -p build
	cd build && cmake \
		-C ../llvm/CheerpCmakeConf.cmake \
		-DCMAKE_BUILD_TYPE=Release \
		-DCLANG_VENDOR="Cheerp ${deb_version}" \
		-DLLVM_ENABLE_PROJECTS=clang \
		../llvm/ \
		-GNinja \
		-DCMAKE_CXX_COMPILER=clang++ \
		-DCMAKE_C_COMPILER=clang \
		-DCMAKE_EXE_LINKER_FLAGS=-fuse-ld=lld \
		-DCMAKE_SHARED_LINKER_FLAGS=-fuse-ld=lld \
		-DCMAKE_MODULE_LINKER_FLAGS=-fuse-ld=lld \

override_dh_auto_install:
	dh_auto_install --builddirectory=build --destdir=debian/tmp

override_dh_auto_build:
	cd build && ninja

override_dh_auto_test:
	cd build && ninja check
